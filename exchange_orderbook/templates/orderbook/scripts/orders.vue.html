{% load exchange %}
{% load i18n %}

<script>
	jQuery(function($) {
		function order_component() {
			return {
				data: {
					price: null,
					amount: null,
					queue_position: 0,
					base_currency: null,
					market_currency: null,
					market_pk: null,
					base_currency_balance: 0,
					market_currency_balance: 0,
					errors: {}
				},
				methods: {
					send: function(type) {
						swal.showLoading();

						var data = {
							price: this.price,
							amount: this.amount,
							market: this.market_pk,
							type: type
						};

						var vm = this;

						$.post('{% url "orderbook>create-order" %}', data, function(response) {
							vm.errors = response.errors || {};

							if (response.order) {
								swal('{% trans "Success!" %}', '{% trans "Your order has been created." %}', 'success').then(function() {
									vm.price = null;
									vm.amount = null;
								});
							}
							else if (response.error) {
								swal('{% trans "Error" %}', response.error, 'error');
							}
							else {
								swal.close();
							}
						});
					},
					find_balances: function() {
						var vm = this;

						var post_1 = $.post('{% url "orderbook>get-available-balance" %}', {symbol: vm.base_currency}, function(response) {
							vm.base_currency_balance = response.available_balance;
						});

						var post_2 = $.post('{% url "orderbook>get-available-balance" %}', {symbol: vm.market_currency}, function(response) {
							vm.market_currency_balance = response.available_balance;
						});

						return [post_1, post_2]
					}
				},
				computed: {
					total: function() {
						return (this.price * this.amount).toFixed(8);
					}
				}
			};
		}

		var new_s_order_config = order_component();
		new_s_order_config.el = '#new-s-order-app';
		var new_s_order_app = new Vue(new_s_order_config);

		var new_b_order_config = order_component();
		new_b_order_config.el = '#new-b-order-app';
		var new_b_order_app = new Vue(new_b_order_config);

		var buy_orders_app = new Vue({
			el: '#buy-orders-app',
			data: {
				orders: [],
				only_my_orders: false
			},
			methods: {
				find_orders: function() {
					var vm = this;
					var only_my_orders_qs = '';

					if (this.only_my_orders) {
						only_my_orders_qs = '?only_my_orders=true';
					}

					return $.get('{% url "orderbook>buy-orders" %}' + only_my_orders_qs, function(orders) {
						vm.orders = orders;
					});
				},
				populate_order: function(item) {
					new_s_order_app.price = item.price;
					new_s_order_app.amount = item.amount;
				},
				cancel_order: function(pk) {
					if (confirm('{% trans "Are you sure you want delete this order?" %}')) {
						swal.showLoading();
						$.post('{% url "orderbook>cancel-my-order-view" %}', {pk: pk}, function(response) {
							swal(_("Success!"), response.message, 'success');
						});
					}
				}
			}
		});

		var sell_orders_app = new Vue({
			el: '#sell-orders-app',
			data: {
				orders: [],
				only_my_orders: false
			},
			methods: {
				find_orders: function() {
					var vm = this;

					var only_my_orders_qs = '';

					if (this.only_my_orders) {
						only_my_orders_qs = '?only_my_orders=true';
					}

					return $.get('{% url "orderbook>sell-orders" %}' + only_my_orders_qs, function(orders) {
						vm.orders = orders;
					});
				},
				cancel_order: function(pk) {
					if (confirm('{% trans "Are you sure you want delete this order?" %}')) {
						$.post('{% url "orderbook>cancel-my-order-view" %}', {pk: pk}, function(response) {
							swal(_("Success!"), response.message, 'success');
						});
					}
				},
				populate_order: function(item) {
					new_b_order_app.price = item.price;
					new_b_order_app.amount = item.amount;
				}
			}
		});

		var executed_orders_app = new Vue({
			el: '#executed-orders-app',
			data: {
				orders: []
			},
			methods: {
				find_orders: function() {
					var vm = this;

					return $.get('{% url "orderbook>executed-orders" %}', function(orders) {
						vm.orders = orders;
					});
				}
			}
		});


		var markets_app = new Vue({
			el: '#markets-app',
			data: {
				base_currencies: {{ base_currencies|serialize|safe }},
				base_currency: null,
				markets: null,
				market_currency: null
			},
			methods: {
				find_markets: function() {
					var vm = this;

					return $.get('{% url "orderbook>markets" %}?base_currency=' + this.base_currency, function(response) {
						vm.markets = response;
					});
				},
				update_apps: function(response) {
					this.market_currency = response.market_currency;

					new_s_order_app.market_currency = response.market_currency;
					new_b_order_app.market_currency = response.market_currency;
					new_s_order_app.market_pk = response.market_pk;
					new_b_order_app.market_pk = response.market_pk;
				},
				set_base_currency: function(symbol) {
					var vm = this;

					$.post('{% url "orderbook>update-base-currency" %}', {'symbol': symbol}, function(response) {
						vm.base_currency = response.base_currency;
						new_s_order_app.base_currency = response.base_currency;
						new_b_order_app.base_currency = response.base_currency;
						
						vm.update_apps(response);
					});
				},
				set_market_currency: function(symbol) {
					var vm = this;

					$.post('{% url "orderbook>update-market-currency" %}', {'symbol': symbol}, function(response) {
						vm.market_currency = response.market_currency;
						vm.update_apps(response);
					});
				}
			},
			mounted: function() {
				var vm = this;

				$.get('{% url "orderbook>my-base-currency" %}', function(response) {
					vm.base_currency = response.base_currency;
					vm.update_apps(response);

					var buy_orders_request = {abort: function(){}};
					var sell_orders_request = {abort: function(){}};
					var executed_orders_request = {abort: function(){}};
					var new_b_order_request = [];
					var new_s_order_request = [];
					var markets_request = {abort: function(){}};

                    setInterval(function() {
                    	buy_orders_request.abort();
						sell_orders_request.abort();
						executed_orders_request.abort();

                        buy_orders_request = buy_orders_app.find_orders();
                        sell_orders_request = sell_orders_app.find_orders();
                        executed_orders_request = executed_orders_app.find_orders();

						for (i in new_b_order_request) {
                        	new_b_order_request[i].abort();
                        }
                        for (i in new_s_order_request) {
                        	new_s_order_request[i].abort();
                        }
                        markets_request.abort();

						new_b_order_request = new_b_order_app.find_balances();
                        new_s_order_request = new_s_order_app.find_balances();
                        markets_request = markets_app.find_markets();
					}, 2000);

					new_s_order_app.base_currency = response.base_currency;
					new_b_order_app.base_currency = response.base_currency;

				});
			},
			watch: {
				base_currency:  function() {
					orderbook_header.exchange_name = this.market_currency;
					orderbook_header.pair = this.market_currency + '/' + this.base_currency;
				},
				market_currency: function() {
					orderbook_header.exchange_name = this.market_currency;
					orderbook_header.pair = this.market_currency + '/' + this.base_currency;
				}
			}
		});


		var orderbook_header = new Vue({
			el: '#orderbook-header',
			data: {
				pair: '',
				exchange_name: ''
			}
		});
	});
</script>