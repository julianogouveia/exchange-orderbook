{% load exchange %}
{% load i18n %}

<script>
	jQuery(function($) {
		var chartData = [];
		generateChartData();


		function generateChartData() {
		  var firstDate = new Date();
		  firstDate.setHours( 0, 0, 0, 0 );
		  firstDate.setDate( firstDate.getDate() - 2000 );

		  for ( var i = 0; i < 2000; i++ ) {
		    var newDate = new Date( firstDate );

		    newDate.setDate( newDate.getDate() + i );

		    var open = Math.round( Math.random() * ( 30 ) + 100 );
		    var close = open + Math.round( Math.random() * ( 15 ) - Math.random() * 10 );

		    var low;
		    if ( open < close ) {
		      low = open - Math.round( Math.random() * 5 );
		    } else {
		      low = close - Math.round( Math.random() * 5 );
		    }

		    var high;
		    if ( open < close ) {
		      high = close + Math.round( Math.random() * 5 );
		    } else {
		      high = open + Math.round( Math.random() * 5 );
		    }

		    var volume = Math.round( Math.random() * ( 1000 + i ) ) + 100 + i;
		    var value = Math.round( Math.random() * ( 30 ) + 100 );

		    chartData[ i ] = ( {
		      "date": newDate,
		      "open": open,
		      "close": close,
		      "high": high,
		      "low": low,
		      "volume": volume,
		      "value": value
		    } );
		  }
		}

		var chart = AmCharts.makeChart( "chartdiv", {
		  "type": "stock",
		  "theme": "light",

		  "dataSets": [ {
		    "fieldMappings": [ {
		      "fromField": "open",
		      "toField": "open"
		    }, {
		      "fromField": "close",
		      "toField": "close"
		    }, {
		      "fromField": "high",
		      "toField": "high"
		    }, {
		      "fromField": "low",
		      "toField": "low"
		    }, {
		      "fromField": "volume",
		      "toField": "volume"
		    }, {
		      "fromField": "value",
		      "toField": "value"
		    } ],
		    "color": "#7f8da9",
		    "dataProvider": chartData,
		    "title": "West Stock",
		    "categoryField": "date"
		  }, {
		    "fieldMappings": [ {
		      "fromField": "value",
		      "toField": "value"
		    } ],
		    "color": "#fac314",
		    "dataProvider": chartData,
		    "compared": true,
		    "title": "East Stock",
		    "categoryField": "date"
		  } ],


		  "panels": [ {
		      "title": "Value",
		      "showCategoryAxis": false,
		      "percentHeight": 70,
		      "valueAxes": [ {
		        "id": "v1",
		        "dashLength": 5
		      } ],

		      "categoryAxis": {
		        "dashLength": 5
		      },

		      "stockGraphs": [ {
		        "type": "candlestick",
		        "id": "g1",
		        "openField": "open",
		        "closeField": "close",
		        "highField": "high",
		        "lowField": "low",
		        "valueField": "close",
		        "lineColor": "#7f8da9",
		        "fillColors": "#7f8da9",
		        "negativeLineColor": "#db4c3c",
		        "negativeFillColors": "#db4c3c",
		        "fillAlphas": 1,
		        "useDataSetColors": false,
		        "comparable": true,
		        "compareField": "value",
		        "showBalloon": false,
		        "proCandlesticks": true
		      } ],

		      "stockLegend": {
		        "divId": "legend1",
		        "valueTextRegular": undefined,
		        "periodValueTextComparing": "[[percents.value.close]]%"
		      }
		    },

		    {
		      "title": "Volume",
		      "percentHeight": 30,
		      "marginTop": 1,
		      "showCategoryAxis": true,
		      "valueAxes": [ {
		        "dashLength": 5
		      } ],

		      "categoryAxis": {
		        "dashLength": 5
		      },

		      "stockGraphs": [ {
		        "valueField": "volume",
		        "type": "column",
		        "showBalloon": false,
		        "fillAlphas": 1
		      } ],

		      "stockLegend": {
		        "divId": "legend2",
		        "markerType": "none",
		        "markerSize": 0,
		        "labelText": "",
		        "periodValueTextRegular": "[[value.close]]"
		      }
		    }
		  ],

		  "chartScrollbarSettings": {
		    "graph": "g1",
		    "graphType": "line",
		    "usePeriod": "WW"
		  },

		  "chartCursorSettings": {
		    "valueLineBalloonEnabled": true,
		    "valueLineEnabled": true
		  },

		  "periodSelector": {
		    "position": "bottom",
		    "periods": [ {
		      "period": "DD",
		      "count": 10,
		      "label": "10 days"
		    }, {
		      "period": "MM",
		      selected: true,
		      "count": 1,
		      "label": "1 month"
		    }, {
		      "period": "YYYY",
		      "count": 1,
		      "label": "1 year"
		    }, {
		      "period": "YTD",
		      "label": "YTD"
		    }, {
		      "period": "MAX",
		      "label": "MAX"
		    } ]
		  }
		} );

		function order_component() {
			return {
				data: {
					price: null,
					amount: null,
					queue_position: 0,
					base_currency: null,
					market_currency: null,
					market_pk: null,
					base_currency_balance: 0,
					market_currency_balance: 0,
					errors: {}
				},
				methods: {
					send: function(type) {
						swal.showLoading();

						var data = {
							price: this.price,
							amount: this.amount,
							market: this.market_pk,
							type: type
						};

						var vm = this;

						$.post('{% url "orderbook>create-order" %}', data, function(response) {
							vm.errors = response.errors || {};

							if (response.order) {
								swal('{% trans "Success!" %}', '{% trans "Your order has been created." %}', 'success').then(function() {
									vm.price = null;
									vm.amount = null;
								});
							}
							else if (response.error) {
								swal('{% trans "Error" %}', response.error, 'error');
							}
							else {
								swal.close();
							}
						});
					},
					find_balances: function() {
						var vm = this;

						function get_available_balance_1() {
							$.post('{% url "orderbook>get-available-balance" %}', {symbol: vm.base_currency}, function(response) {
								vm.base_currency_balance = response.available_balance;
							}).always(function() {
								setTimeout(function() {
									get_available_balance_1();
								}, 1000);
							});
						}

						function get_available_balance_2() {
							$.post('{% url "orderbook>get-available-balance" %}', {symbol: vm.market_currency}, function(response) {
								vm.market_currency_balance = response.available_balance;
							}).always(function() {
								setTimeout(function() {
									get_available_balance_2();
								}, 1000);
							});
						}

						get_available_balance_1();
						get_available_balance_2();
					}
				},
				computed: {
					total: function() {
						return (this.price * this.amount).toFixed(8);
					}
				}
			};
		}

		var new_s_order_config = order_component();
		new_s_order_config.el = '#new-s-order-app';
		var new_s_order_app = new Vue(new_s_order_config);

		var new_b_order_config = order_component();
		new_b_order_config.el = '#new-b-order-app';
		var new_b_order_app = new Vue(new_b_order_config);

		var buy_orders_app = new Vue({
			el: '#buy-orders-app',
			data: {
				orders: [],
				only_my_orders: false
			},
			methods: {
				find_orders: function() {
					var vm = this;
					
					function get_buy_orders() {
						var only_my_orders_qs = '';

						if (vm.only_my_orders) {
							only_my_orders_qs = '?only_my_orders=true';
						}

						$.get('{% url "orderbook>buy-orders" %}' + only_my_orders_qs, function(orders) {
							vm.orders = orders;
						}).always(function() {
							setTimeout(function() {
								get_buy_orders();
							}, 1000);
						});
					}

					get_buy_orders();
				},
				populate_order: function(item) {
					new_s_order_app.price = item.price;
					new_s_order_app.amount = item.amount;
				},
				cancel_order: function(pk) {
					if (confirm('{% trans "Are you sure you want delete this order?" %}')) {
						swal.showLoading();
						$.post('{% url "orderbook>cancel-my-order-view" %}', {pk: pk}, function(response) {
							swal(_("Success!"), response.message, 'success');
						});
					}
				}
			}
		});

		var sell_orders_app = new Vue({
			el: '#sell-orders-app',
			data: {
				orders: [],
				only_my_orders: false
			},
			methods: {
				find_orders: function() {
					var vm = this;

					function get_sell_orders() {
						var only_my_orders_qs = '';

						if (vm.only_my_orders) {
							only_my_orders_qs = '?only_my_orders=true';
						}

						$.get('{% url "orderbook>sell-orders" %}' + only_my_orders_qs, function(orders) {
							vm.orders = orders;
						}).always(function() {
							setTimeout(function() {
								get_sell_orders();
							}, 1000);
						});
					}

					get_sell_orders();
				},
				cancel_order: function(pk) {
					if (confirm('{% trans "Are you sure you want delete this order?" %}')) {
						$.post('{% url "orderbook>cancel-my-order-view" %}', {pk: pk}, function(response) {
							swal(_("Success!"), response.message, 'success');
						});
					}
				},
				populate_order: function(item) {
					new_b_order_app.price = item.price;
					new_b_order_app.amount = item.amount;
				}
			}
		});

		var executed_orders_app = new Vue({
			el: '#executed-orders-app',
			data: {
				orders: []
			},
			methods: {
				find_orders: function() {
					var vm = this;

					function get_executed_orders() {
						$.get('{% url "orderbook>executed-orders" %}', function(orders) {
							vm.orders = orders;
						}).always(get_executed_orders);
					}

					get_executed_orders();
				}
			}
		});


		var markets_app = new Vue({
			el: '#markets-app',
			data: {
				base_currencies: {{ base_currencies|serialize|safe }},
				base_currency: null,
				markets: null,
				market_currency: null
			},
			methods: {
				find_markets: function() {
					var vm = this;

					function get_markets() {
						$.get('{% url "orderbook>markets" %}?base_currency=' + vm.base_currency, function(response) {
							vm.markets = response;
						}).always(function() {
							setTimeout(function() {
								get_markets	();
							}, 1000);
						});
					}

					get_markets();
				},
				update_apps: function(response) {
					this.market_currency = response.market_currency;

					new_s_order_app.market_currency = response.market_currency;
					new_b_order_app.market_currency = response.market_currency;
					new_s_order_app.market_pk = response.market_pk;
					new_b_order_app.market_pk = response.market_pk;
				},
				set_base_currency: function(symbol) {
					var vm = this;

					$.post('{% url "orderbook>update-base-currency" %}', {'symbol': symbol}, function(response) {
						vm.base_currency = response.base_currency;
						new_s_order_app.base_currency = response.base_currency;
						new_b_order_app.base_currency = response.base_currency;
						
						vm.update_apps(response);
					});
				},
				set_market_currency: function(symbol) {
					var vm = this;

					$.post('{% url "orderbook>update-market-currency" %}', {'symbol': symbol}, function(response) {
						vm.market_currency = response.market_currency;
						vm.update_apps(response);
					});
				}
			},
			mounted: function() {
				var vm = this;

				$.get('{% url "orderbook>my-base-currency" %}', function(response) {
					vm.base_currency = response.base_currency;
					vm.update_apps(response);

                    buy_orders_app.find_orders();
                    sell_orders_app.find_orders();
                    executed_orders_app.find_orders();

					new_b_order_app.find_balances();
                    new_s_order_app.find_balances();
                    markets_app.find_markets();

					new_s_order_app.base_currency = response.base_currency;
					new_b_order_app.base_currency = response.base_currency;

				});
			},
			watch: {
				base_currency:  function() {
					orderbook_header.exchange_name = this.market_currency;
					orderbook_header.pair = this.market_currency + '/' + this.base_currency;
				},
				market_currency: function() {
					orderbook_header.exchange_name = this.market_currency;
					orderbook_header.pair = this.market_currency + '/' + this.base_currency;
				}
			}
		});


		var orderbook_header = new Vue({
			el: '#orderbook-header',
			data: {
				pair: '',
				exchange_name: ''
			}
		});
	});
</script>